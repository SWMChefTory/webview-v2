name: Docker Build and Deploy (Dev)

on:
  push:
    branches:
      - dev  # dev 브랜치 푸시 시 자동 배포
      - 'feat/**'  # feat/로 시작하는 브랜치 푸시 시 자동 배포
  workflow_dispatch:  # 수동 실행 가능

jobs:
  build-and-deploy:
    runs-on: self-hosted  # Runner 서버에서 빌드

    steps:
      - name: Checkout repository
        uses: actions/checkout@v4

      - name: Extract commit info
        id: commit
        run: |
          COMMIT_SHA=$(git rev-parse --short HEAD)
          COMMIT_MSG=$(git log -1 --pretty=%B)
          echo "sha=$COMMIT_SHA" >> $GITHUB_OUTPUT
          echo "message=$COMMIT_MSG" >> $GITHUB_OUTPUT

      - name: Build Docker image
        timeout-minutes: 20
        run: |
          docker build \
            --build-arg NEXT_PUBLIC_BASE_URL=${{ secrets.NEXT_PUBLIC_BASE_URL }} \
            --build-arg NEXT_PUBLIC_STT_URL=${{ secrets.NEXT_PUBLIC_STT_URL }} \
            --build-arg NEXT_PUBLIC_AMPLITUDE_API_KEY=${{ secrets.NEXT_PUBLIC_AMPLITUDE_API_KEY }} \
            -t cheftory-webview:latest .

      - name: Save Docker image to tar
        run: |
          docker save cheftory-webview:latest -o cheftory-webview.tar

      - name: Check tar file size
        run: |
          ls -lh cheftory-webview.tar
          echo "Image size: $(du -h cheftory-webview.tar | cut -f1)"

      - name: Transfer Docker image to deployment server
        run: |
          scp -P ${{ secrets.DEPLOY_SERVER_PORT }} \
            cheftory-webview.tar \
            ${{ secrets.DEPLOY_SERVER_USER }}@${{ secrets.DEPLOY_SERVER_HOST }}:/home/filient/docker/cheftory_webview/

      - name: Transfer docker-compose file
        run: |
          scp -P ${{ secrets.DEPLOY_SERVER_PORT }} \
            docker-compose.dev.yml \
            ${{ secrets.DEPLOY_SERVER_USER }}@${{ secrets.DEPLOY_SERVER_HOST }}:/home/filient/docker/cheftory_webview/

      - name: Deploy on deployment server
        run: |
          ssh -p ${{ secrets.DEPLOY_SERVER_PORT }} \
            ${{ secrets.DEPLOY_SERVER_USER }}@${{ secrets.DEPLOY_SERVER_HOST }} << 'EOF'
            cd /home/filient/docker/cheftory_webview

            # Docker 이미지 로드
            echo "Loading Docker image..."
            docker load -i cheftory-webview.tar

            # 기존 컨테이너 중지 및 제거
            echo "Stopping existing container..."
            docker compose -f docker-compose.dev.yml down || true

            # 새 컨테이너 시작
            echo "Starting new container..."
            docker compose -f docker-compose.dev.yml up -d

            # 컨테이너 상태 확인
            echo "Checking container status..."
            docker compose -f docker-compose.dev.yml ps

            # 오래된 cheftory-webview 이미지만 정리
            echo "Cleaning up old cheftory-webview images..."
            docker images | grep cheftory-webview | grep "<none>" | awk '{print $3}' | xargs -r docker rmi || true

            # tar 파일 삭제
            echo "Removing tar file..."
            rm -f cheftory-webview.tar

            # Health check
            echo "Verifying deployment..."
            sleep 5
            curl -f http://localhost:3004/ || exit 1

            echo "Deployment completed successfully!"
          EOF

      - name: Cleanup local tar file
        if: always()
        run: |
          rm -f cheftory-webview.tar

      - name: Cleanup local Docker images
        if: always()
        run: |
          # 오래된 cheftory-webview dangling 이미지 정리
          echo "Cleaning up old cheftory-webview images on runner server..."
          docker images | grep cheftory-webview | grep "<none>" | awk '{print $3}' | xargs -r docker rmi || true
          echo "Runner server cleanup completed"

      - name: Deployment summary
        if: success()
        run: |
          echo "✅ Dev deployment successful!"
          echo "Commit: ${{ steps.commit.outputs.sha }}"
          echo "Message: ${{ steps.commit.outputs.message }}"
          echo "Container: cheftory-webview"
          echo "Port: 3004"
          echo "URL: https://app-dev.cheftories.com"
